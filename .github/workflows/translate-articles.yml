name: Translate Markdown with Groq

env:
  LANGUAGES: ${{ secrets.TRANSLATION_LANGUAGES || 'ja' }}

on:
  push:
    paths:
      - 'articles/**/*.md' # ç¿»è¨³å¯¾è±¡ã®Markdownãƒ•ã‚¡ã‚¤ãƒ«
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # å¤‰æ›´ã•ã‚ŒãŸMarkdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
      - name: Get changed markdown files
        id: files
        run: |
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep "^articles/.*\.md$" > $GITHUB_WORKSPACE/changed_files.txt
          echo "ğŸ“‹ Changed markdown files:"
          cat $GITHUB_WORKSPACE/changed_files.txt
        continue-on-error: true
        shell: bash
        
       # å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã•ã‚ŒãŸè¨€èªã«ç¿»è¨³
      - name: Translate files to multiple languages
        run: |
          while IFS= read -r file; do
            echo "Processing file: $file"
            base_name=$(basename "$file" .md)
            for lang in "${LANGUAGES[@]}"; do
              echo "Translating $file to $lang..."
              translated_file="articles/${base_name}_${lang}.md"

              # Groqã‚’ä½¿ç”¨ã—ã¦ç¿»è¨³
              translated_content=$(gh api -X POST repos/${{ github.repository }}/actions/workflows/<workflow_id>/dispatches \
                -f ref=${{ github.ref }} \
                -f inputs.config="$(cat <<EOF
                {
                  "provider": "groq",
                  "provider_options": {
                    "api_key": "${{ secrets.GROQ_API_KEY }}"
                  },
                  "system": "You are a professional Markdown translator specializing in technical documents. Translate the following content to ${lang}:",
                  "prompt": "$(cat $file)",
                  "model": "compound-beta"
                }
                EOF
                )")

              # ç¿»è¨³çµæœã‚’ä¿å­˜
              echo "$translated_content" > "$translated_file"
              echo "Saved translated file: $translated_file"
            done
          done < $GITHUB_WORKSPACE/changed_files.txt
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

      # ç¿»è¨³çµæœã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
      - name: Commit and push changes
        run: |
          $GITHUB_WORKSPACE/changed_files.txt
          git config --local user.name ${{ github.actor }}
          git config --local user.email ${{ github.actor }}@users.noreply.github.com
          git add articles/*_*.md
          git commit -m "Add translated Markdown files"
          git push
        shell: bash
        if: steps.files.outcome == 'success'
