name: Translate Markdown with Groq

env:
  LANGUAGES: ${{ secrets.TRANSLATION_LANGUAGES || 'ja' }}

on:
  push:
    paths:
      - 'articles/**/*.md' # 翻訳対象のMarkdownファイル
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # 変更されたMarkdownファイルを取得
      - name: Get changed Markdown files
        id: get-files
        run: |
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep "^articles/.*\.md$" > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt
          
       # 各ファイルを指定された言語に翻訳
      - name: Translate files to multiple languages
        run: |
          while IFS= read -r file; do
            echo "Processing file: $file"
            base_name=$(basename "$file" .md)
            for lang in "${LANGUAGES[@]}"; do
              echo "Translating $file to $lang..."
              translated_file="articles/${base_name}_${lang}.md"

              # Groqを使用して翻訳
              translated_content=$(gh api -X POST repos/${{ github.repository }}/actions/workflows/<workflow_id>/dispatches \
                -f ref=${{ github.ref }} \
                -f inputs.config="$(cat <<EOF
                {
                  "provider": "groq",
                  "provider_options": {
                    "api_key": "${{ secrets.GROQ_API_KEY }}"
                  },
                  "system": "You are a professional Markdown translator specializing in technical documents. Translate the following content to ${lang}:",
                  "prompt": "$(cat $file)",
                  "model": "compound-beta"
                }
                EOF
                )")

              # 翻訳結果を保存
              echo "$translated_content" > "$translated_file"
              echo "Saved translated file: $translated_file"
            done
          done < changed_files.txt
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

      # 翻訳結果をコミット＆プッシュ
      - name: Commit and push changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add articles/*_*.md
          git commit -m "Add translated Markdown files"
          git push origin ${{ github.ref_name }}
